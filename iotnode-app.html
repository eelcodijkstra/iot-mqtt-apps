<!doctype html>
<html>
  <head>
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
    <script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>
    <style>
      body {padding-left:20px;}
      #led0 {background-color:red;}
      #led1 {background-color:green;}
    </style>
  </head>
  <body style="width:320px;">
    <h2>IoT-node simulator</h2>
    <div>
      <form id="iotform">
        <div>
          <button style="border-radius: 25%; width:80px;">led0</button>
          <button style="border-radius: 25%; width:80px;">led1</button>
          <input data-inline="true" value="Led0" id="led0" type="button">
          <input data-inline="true" value="Led1" id="led1" type="button">
        </div>
        <div>
          <input data-inline="true" value="Button0" id="button0" type="button">
          <input data-inline="true" value="Button1" id="button1" type="button">
        </div>
      </form>
    </div>
    <div style="width:320px;">
      <form >
        <label for="tempSlider">Temperature (&deg;C):</label>
        <input name="tempSlides" id="tempSlider" min="0" max="50" value="25" type="range">
        <label for="presSlider">Atm.pressure (hPa):</label>
        <input name="presSlider" id="presSlider" min="970" max="1050" value="1010" type="range">
      </form>
    </div>
    <hr>
    <div>
      <form style="width:100px;">
        <label for="nodeid">Node-id:</label>
        <input type="text" name="nodeid" id="nodeid" value="e0f1" >
      </form>
    </div>
    <script>
    // example from: https://www.eclipse.org/paho/clients/js/
    /* global Paho */

    // Create a client instance
    var mqttbroker = {
      hostname: "infvoplein.nl",
      port: 1884
    };

    var randomnr = Math.floor((Math.random() * 10000));
    var clientId = "mqtt-client-x-" + randomnr.toString();
    var client = new Paho.MQTT.Client(mqttbroker.hostname, Number(mqttbroker.port), clientId);

    var nodeid = "x", sensorTopic = "", actuatorTopic = "";

    // set callback handlers
    client.onConnectionLost = onConnectionLost;
    client.onMessageArrived = onMessageArrived;

    function onFailure() {
      alert("connection failed");
    }

    // called when the client connects
    function onConnect() {
      // Once a connection has been made, make a subscription and send a message.
      console.log("onConnect");
      client.subscribe(actuatorTopic);
      var message = new Paho.MQTT.Message("Hello from " + nodeid);
      message.destinationName = "nodes";
      client.send(message); // to test connection
      sendSensorValues();
    }

    // called when the client loses its connection
    function onConnectionLost(responseObject) {
      if (responseObject.errorCode !== 0) {
        console.log("onConnectionLost:"+responseObject.errorMessage);
      }
    }

    // called when a message arrives
    function onMessageArrived(message) {
      console.log("onMessageArrived:" + message.payloadString);
      console.log("destination: " + message.destinationName);

      // display sensor values of current iotnode, when applicable:
      var substrings = message.destinationName.split("/");
      if (substrings.length == 3 &&
        substrings[0] == "node" &&
        substrings[1] == nodeid &&
        substrings[2] == "actuators" ) {
          var obj = {};
          try {
            obj = JSON.parse(message.payloadString);
          } catch (e) {
            obj = {error: e, payload: message.payloadString};
          }
          if ("led0" in obj) {
            if (obj.led0) {
              $("#led0").css("background-color", "red");
            } else {
              $("#led0").css("background-color", "white");
            }
          }
          if ("led1" in obj) {
            if (obj.led1) {
              $("#led1").css("background-color", "red");
            } else {
              $("#led1").css("background-color", "white");
            }
          }
          console.log("handled: " + JSON.stringify(obj));
        }
      }

      function connectMQTT() {
        console.log("before connect");

        nodeid = $("#nodeid").val();
        sensorTopic = "node/" + nodeid + "/sensors";
        actuatorTopic = "node/" + nodeid + "/actuators";
        client.connect({onSuccess:onConnect, onFailure:onFailure});
      }

      function button0Handler() {
        console.log("button0");
        sendSensorValues(1,0);
      }

      function button1Handler() {
        console.log("button1");
        sendSensorValues(1,0);
      }

      function sendSensorValues(b0, b1) {
        var obj = {};
        obj.button0 = b0;
        obj.button1 = b1;
        obj.temp = $("#tempSlider").val();
        obj.pres = $("#presSlider").val();
        obj.id = nodeid;
        console.log("send: " + JSON.stringify(obj));
        var msg = new Paho.MQTT.Message(JSON.stringify(obj));
        msg.destinationName = sensorTopic;
        client.send(msg);
      }

      function nodeidHandler() {
        var newid = $("#nodeid").value;
        if (newid !== nodeid) {
          client.unsubscribe(sensorTopic);
          client.unsubscribe(actuatorTopic);
          nodeid = newid;
          sensorTopic = "node/" + nodeid + "/sensors";
          actuatorTopic = "node/" + nodeid + "/actuators";
          client.subscribe(actuatorTopic);
        }
      }
      
      function timerHandler() {
        if (!client.isConnected()) {
          connectMQTT()
        } else {
          sendSensorValues(0, 0);          
        }      
      }

      $("#nodeid").change(nodeidHandler);
      $("#button0").click(button0Handler);
      $("#button1").click(button1Handler);
      connectMQTT();
      setInterval(timerHandler, 50000);
      </script>
  </body
</html>
