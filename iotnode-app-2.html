<!doctype html>
<html>
  <head>
    <title>IoT-node-0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>
    <style>
      body {padding-left:20px;}
      #led0 {background-color:skyblue;}
      #led1 {background-color:skyblue;}
      .box {
        display: flex;
        border: 1px solid blue;
        padding: 10px;
      }
      input {
        font-size: 80%;
      }
    </style>
  </head>
  <body style="width:320px;">
    <h2>IoT-node simulator (v0.2)</h2>
    <div class="box" style="width:300px;">
      <button style="border-radius: 15%; width:80px; margin: auto; margin-right:20px;" id="led0">led0</button>
      <button style="border-radius: 15%; width:80px; margin: auto; margin-left:20px;" id="led1">led1</button>
    </div>
    <div class="box" style="width:300px;">
      <button style="margin: auto; margin-right:10px;" id="button0">Button0</button>
      <button style="margin: auto; margin-left:10px;" id="button1">Button1</button>
    </div>
    <div class="box" style="width:300px;">
      Temp. (&deg;C) 
      <input type="range" min="0" max="50" style="width:200px;" id="tempSlider">
      <input type="text" value="10" style="width:30px;" id="tempValue">
    </div>
    <div class="box" style="width:300px; padding: 10px;">
      Baro. (hPa) 
      <input type="range" min="950" max="1050" style="width:200px;" id="baroSlider">
      <input type="text" value="10" style="width:30px;" id="baroValue">
    </div>    
    
    <hr>
    <div class="box" style="width:300px;">
        <label for="nodeid">Node-id:</label>
        <input type="text" name="nodeid" id="nodeid" value="e0f1" style="width:30px; margin: auto;">
    </div>
    <script>
    // example from: https://www.eclipse.org/paho/clients/js/
    /* global Paho */

    // Create a client instance
    var mqttbroker = {
      hostname: "infvopedia.nl",
      port: 1884
    };

    var randomnr = Math.floor((Math.random() * 10000));
    var clientId = "mqtt-client-x-" + randomnr.toString();
    var client = new Paho.MQTT.Client(mqttbroker.hostname, Number(mqttbroker.port), clientId);

    var nodeid = "x", sensorTopic = "", actuatorTopic = "";
      
    var led0 = 0, led1 = 0;

    // set callback handlers
    client.onConnectionLost = onConnectionLost;
    client.onMessageArrived = onMessageArrived;

    function onFailure() {
      alert("connection failed");
    }

    // called when the client connects
    function onConnect() {
      // Once a connection has been made, make a subscription and send a message.
      console.log("onConnect");
      client.subscribe(actuatorTopic);
      var message = new Paho.MQTT.Message("Hello from " + nodeid);
      message.destinationName = "nodes";
      client.send(message); // to test connection
      sendSensorValues();
    }

    // called when the client loses its connection
    function onConnectionLost(responseObject) {
      if (responseObject.errorCode !== 0) {
        console.log("onConnectionLost:"+responseObject.errorMessage);
      }
    }

    // called when a message arrives
    function onMessageArrived(message) {
      console.log("onMessageArrived:" + message.payloadString);
      console.log("destination: " + message.destinationName);

      // display sensor values of current iotnode, when applicable:
      var substrings = message.destinationName.split("/");
      if (substrings.length == 3 &&
        substrings[0] == "node" &&
        substrings[1] == nodeid &&
        substrings[2] == "actuators" ) {
          var obj = {};
          try {
            obj = JSON.parse(message.payloadString);
          } catch (e) {
            obj = {error: e, payload: message.payloadString};
          }
          if ("0" in obj && "dOut" in obj["0"]) {
            if (obj["0"].dOut) {
              document.getElementById("led0").style.backgroundColor = "red";
              led0 = 1;
            } else {
              document.getElementById("led0").style.backgroundColor = "white";
              led0 = 0;
            }
          }
          if ("1" in obj && "dOut" in obj["1"]) {
            if (obj["1"].dOut) {
              document.getElementById("led1").style.backgroundColor = "red";
              led1 = 1;
            } else {
              document.getElementById("led1").style.backgroundColor = "white";
              led1 = 0;
            }
          }
          sendSensorValues(0, 0);
          console.log("handled: " + JSON.stringify(obj));
          
        }
      }

      function connectMQTT() {
        console.log("before connect");

        nodeid = document.getElementById("nodeid").value;
        console.log("nodeid: " + nodeid);
        sensorTopic = "node/" + nodeid + "/sensors";
        actuatorTopic = "node/" + nodeid + "/actuators";
        client.connect({
          userName: "mqtttest", password: "testmqtt",
          onSuccess: onConnect, onFailure: onFailure});
      }

      function button0Handler() {
        console.log("button0");
        sendSensorValues(1,0);
      }

      function button1Handler() {
        console.log("button1");
        sendSensorValues(0,1);
      }

      function sendSensorValues(b0, b1) {
        var obj = {};
        obj.nodeid = nodeid;
        obj.count = count;
        count = count + 1;
        obj.payload = {};
        obj.payload["0"] = {dOut: led0};
        obj.payload["1"] = {dOut: led1};
        if (b0) {
          obj.payload["2"] = {dIn: b0};
        }
        if (b1) {
          obj.payload["3"] = {dIn: b1};          
        }
        obj.payload["4"] = {temperature: document.getElementById("tempSlider").value * 10};
        obj.payload["5"] = {barometer: document.getElementById("baroSlider").value * 10};
        console.log("send: " + JSON.stringify(obj));
        var msg = new Paho.MQTT.Message(JSON.stringify(obj));
        msg.destinationName = sensorTopic;
        client.send(msg);
      }
      
      function sliderHandler() {
        console.log("slider changed");
        var temp = document.getElementById("tempSlider").value;
        var baro = document.getElementById("baroSlider").value;
        document.getElementById("tempValue").value = temp;
        document.getElementById("baroValue").value = baro; 
        // sendSensorValues(0,0); - only at regular intervals, like phys. IoT-node
      }

      function nodeidHandler() {
        var newid = document.getElementById("nodeid").value;
        if (newid !== nodeid) {
          client.unsubscribe(sensorTopic);
          client.unsubscribe(actuatorTopic);
          nodeid = newid;
          sensorTopic = "node/" + nodeid + "/sensors";
          actuatorTopic = "node/" + nodeid + "/actuators";
          client.subscribe(actuatorTopic);
        }
      }
      
      function timerHandler() {
        if (!client.isConnected()) {
          connectMQTT()
        } else {
          sendSensorValues(0, 0);          
        }      
      }

      var temp = document.getElementById("tempSlider").value;
      var baro = document.getElementById("baroSlider").value;
      var count = 0;
      document.getElementById("tempValue").value = temp;
      document.getElementById("baroValue").value = baro;
      document.getElementById("nodeid").onchange = nodeidHandler;
      document.getElementById("button0").onclick = button0Handler;
      document.getElementById("button1").onclick = button1Handler;
      document.getElementById("tempSlider").onchange = sliderHandler;
      document.getElementById("baroSlider").onchange = sliderHandler;
      connectMQTT();
      setInterval(timerHandler, 50000); // 50 sec
      </script>
  </body
</html>
